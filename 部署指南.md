# 🎄 3D 粒子交互项目 - 完整部署和开发指南

## 📋 项目概述

这是一个基于 React + Three.js + MediaPipe 的 3D 粒子交互项目，支持：
- ✅ 实时手势识别（AI 驱动）
- ✅ 摄像头访问（电脑和手机）
- ✅ 3D 粒子动画
- ✅ 支持 Netlify 等静态托管平台部署

---

## 🎯 您遇到的问题及解决方案

### ❌ 问题 1: 本地打开不显示粒子 + 黑屏
**原因：**
- Vite 开发服务器启用了自签名 HTTPS，浏览器阻止了不安全的资源加载
- WASM 文件需要特殊的跨域头（COOP/COEP）

**✅ 已修复：**
- 本地开发改为 HTTP（localhost 可以访问摄像头）
- 添加了正确的 CORS 和安全头配置

### ❌ 问题 2: "此站点的链接不安全"警告
**原因：**
- 自签名 HTTPS 证书被浏览器标记为不安全

**✅ 已修复：**
- 本地开发使用 HTTP（`http://localhost:5173`）
- Netlify 部署会自动提供正规的 SSL 证书

### ❌ 问题 3: 不了解如何保证跨平台运行
**✅ 请看下方的"核心知识点"部分**

---

## 🧠 核心知识点：摄像头 + AI 项目必备知识

### 1️⃣ **浏览器安全策略（关键！）**

#### 📹 摄像头访问规则
```javascript
navigator.mediaDevices.getUserMedia({ video: true })
```

**可以访问摄像头的情况：**
- ✅ `https://` 网站（正规 SSL 证书）
- ✅ `http://localhost` 或 `http://127.0.0.1`（本地调试例外）
- ❌ `http://` 其他域名（会被浏览器拒绝）
- ❌ `http://192.168.x.x`（局域网 IP 也需要 HTTPS）

**移动端测试建议：**
- 在手机上测试时，必须使用 HTTPS 部署（如 Netlify）
- 或使用 ngrok 等工具将本地服务映射到 HTTPS 域名

---

### 2️⃣ **WebAssembly (WASM) 运行要求**

MediaPipe 的 AI 模型依赖 WASM，需要特殊的 HTTP 头：

```http
Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Embedder-Policy: require-corp
```

**为什么需要这些头？**
- 启用 `SharedArrayBuffer`（高性能并行计算）
- 保证 WASM 模块安全隔离

**如何配置？**
- ✅ 本地开发：在 `vite.config.ts` 的 `server.headers` 中配置
- ✅ Netlify 部署：在 `netlify.toml` 中配置（已完成）

---

### 3️⃣ **静态资源路径处理**

#### 本地开发 vs 部署的路径差异

| 环境 | `public/wasm/file.wasm` 的访问路径 |
|------|----------------------------------|
| Vite 开发 | `http://localhost:5173/wasm/file.wasm` |
| Netlify | `https://your-site.netlify.app/wasm/file.wasm` |

**关键点：**
- ✅ 使用 **绝对路径** `/wasm/...`（从根目录开始）
- ❌ 避免相对路径 `./wasm/...`（在不同路由下会出错）
- ✅ Vite 会自动把 `public/` 目录的文件复制到 `dist/`

---

### 4️⃣ **AI 模型文件处理**

项目包含两个关键 AI 文件：
1. `hand_landmarker.task` (模型文件，~9MB)
2. `vision_wasm_internal.wasm` (WASM 运行时)

**部署到 Netlify 时需要：**
- ✅ 确保这些文件在 `public/` 目录下
- ✅ 运行 `npm run build` 会自动复制到 `dist/`
- ✅ 上传整个 `dist/` 文件夹到 Netlify

**优化建议：**
- 模型文件较大，建议配置 CDN 缓存（已在 `netlify.toml` 中设置）
- 首次加载会慢，可添加加载进度条

---

## 🚀 本地开发步骤

### 1. 安装依赖
```powershell
npm install
```

### 2. 启动开发服务器
```powershell
npm run dev
```

### 3. 访问网站
打开浏览器访问：
```
http://localhost:5173
```

### 4. 测试摄像头
1. 点击右上角的 "START CAM" 按钮
2. 浏览器会请求摄像头权限，点击"允许"
3. 看到视频画面后，挥动手掌即可控制粒子

---

## 📦 Netlify 部署步骤

### 方式 1: 通过 Netlify Web UI（推荐新手）

1. **构建项目：**
```powershell
npm run build
```
这会生成 `dist/` 文件夹，包含所有静态文件。

2. **登录 Netlify：**
访问 [netlify.com](https://www.netlify.com) 并登录。

3. **拖拽上传：**
- 点击 "Add new site" → "Deploy manually"
- 直接拖拽整个 `dist/` 文件夹到页面上
- 等待部署完成（约 30 秒）

4. **测试：**
访问 Netlify 提供的 `https://xxx.netlify.app` 链接。

---

### 方式 2: 通过 Git 仓库（推荐团队协作）

1. **将代码推送到 GitHub：**
```powershell
git init
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/你的用户名/你的仓库.git
git push -u origin main
```

2. **在 Netlify 连接仓库：**
- Netlify 控制台 → "Add new site" → "Import from Git"
- 选择你的 GitHub 仓库
- 构建设置会自动读取 `netlify.toml`（已配置好）

3. **配置构建参数（自动识别）：**
```
Build command: npm run build
Publish directory: dist
```

4. **每次 `git push` 都会自动重新部署！**

---

## 🔧 部署后检查清单

部署完成后，请检查以下内容：

### ✅ 1. HTTPS 状态
- 打开浏览器 F12 控制台
- 应该看到绿色锁图标
- 如果显示 "Mixed Content" 警告，说明有 HTTP 资源被阻止

### ✅ 2. 摄像头权限
- 点击 "START CAM"
- 浏览器应弹出权限请求
- 如果提示"需要 HTTPS"，检查 URL 是否是 `https://`

### ✅ 3. 控制台日志
按 F12 打开控制台，应该看到：
```
[HandTracker] 开始初始化 AI 模型...
[HandTracker] 加载 WASM 文件: /wasm
[HandTracker] ✓ 使用本地模型文件
[HandTracker] ✓ GPU 初始化成功
[HandTracker] ✓ AI 模型准备完毕
```

如果有错误，根据提示排查：
- `NetworkError` → 检查网络连接
- `CORS error` → 检查 `netlify.toml` 配置
- `Camera access denied` → 检查浏览器权限设置

### ✅ 4. 资源加载
在 F12 → Network 标签中，检查以下文件是否成功加载：
- ✅ `hand_landmarker.task` (约 9MB)
- ✅ `vision_wasm_internal.wasm` (约 2MB)
- ✅ `vision_wasm_internal.js`

---

## 📱 移动端测试

### iOS Safari
- ✅ 支持摄像头访问（需要 HTTPS）
- ✅ 支持 WASM（iOS 11.3+）
- ⚠️ 首次加载可能较慢（模型文件大）

### Android Chrome
- ✅ 完全支持
- ✅ 性能较好（GPU 加速）

### 移动端调试技巧
1. 在手机上访问 Netlify 提供的 HTTPS 链接
2. 使用 Chrome Remote Debugging：
   ```
   chrome://inspect#devices
   ```
3. 查看手机浏览器的控制台日志

---

## 🐛 常见问题及解决方案

### 1️⃣ 粒子不显示
**可能原因：**
- WebGL 未启用
- 浏览器不支持

**解决方案：**
```javascript
// 在 Chrome 中启用硬件加速
chrome://settings → 高级 → 系统 → 使用硬件加速
```

---

### 2️⃣ 摄像头黑屏
**可能原因：**
- 权限被拒绝
- 摄像头被其他应用占用

**解决方案：**
```
1. 检查浏览器地址栏左侧的摄像头图标
2. 点击 → 允许访问摄像头
3. 关闭其他使用摄像头的程序（如 Zoom、微信视频）
```

---

### 3️⃣ AI 模型加载失败
**错误信息：** `NetworkError: Failed to fetch`

**解决方案：**
1. 检查网络连接
2. 确认 `public/hand_landmarker.task` 文件存在
3. 清除浏览器缓存后重试
4. 检查 Netlify 上的文件大小（应该是 9MB+）

---

### 4️⃣ CORS 错误
**错误信息：** `CORS policy blocked`

**解决方案：**
确保 `netlify.toml` 包含正确的头配置：
```toml
[[headers]]
  for = "/*"
  [headers.values]
    Cross-Origin-Opener-Policy = "same-origin"
    Cross-Origin-Embedder-Policy = "require-corp"
```

---

### 5️⃣ 黑屏和 WebGL 上下文丢失 ⚠️ **新增**
**错误信息：** `THREE.WebGLRenderer: Context Lost`

**原因：**
- GPU 过载（同时运行摄像头 AI + 3D 渲染）
- 浏览器内存不足
- 显卡驱动问题

**已优化的解决方案：**
1. ✅ **降低粒子数量**：从 4000 降至 3000（移动端 2000）
2. ✅ **AI 使用 CPU**：避免与 Three.js 竞争 GPU
3. ✅ **降低摄像头分辨率**：从 640x480 降至 480x360
4. ✅ **降低帧率**：从 30fps 降至 24fps
5. ✅ **移除 Environment 组件**：不再加载外部 HDR 文件

**用户端操作：**
- 关闭其他标签页和应用，释放内存
- 更新显卡驱动程序
- 如果是集成显卡，考虑关闭摄像头交互，只观看粒子效果

**检查显卡支持：**
访问 `chrome://gpu/` 查看 WebGL 状态，确保：
- WebGL: Hardware accelerated
- WebGL2: Hardware accelerated

---

### 6️⃣ Environment 加载失败 ⚠️ **新增**
**错误信息：** `Could not load potsdamer_platz_1k.hdr: Failed to fetch`

**原因：**
- `<Environment preset="city" />` 尝试从 drei 的 CDN 加载 HDR 文件失败
- 网络问题或 CDN 不可用

**已修复：**
✅ 移除了 `<Environment>` 组件，改用本地光源：
```jsx
<ambientLight intensity={0.3} />
<pointLight position={[10, 10, 10]} intensity={0.5} />
```

---

## 🎯 性能优化配置总结

| 配置项 | 优化前 | 优化后 | 原因 |
|--------|--------|--------|------|
| 粒子数量 | 4000 | 3000 (PC) / 2000 (移动) | 减少 GPU 负担 |
| 摄像头分辨率 | 640x480 | 480x360 | 降低视频处理压力 |
| 摄像头帧率 | 30fps | 24fps | 减少 AI 计算频率 |
| AI 处理器 | GPU | CPU | 避免与 WebGL 冲突 |
| 环境光 | CDN HDR | 本地光源 | 消除外部依赖 |

---

## 📊 性能优化建议

### 1. 减小初始加载时间
- 使用 CDN 加速模型文件（已配置 Cache-Control）
- 添加 Service Worker 实现离线缓存

### 2. 移动端优化
- 降低粒子数量（当前 4000 → 可改为 2000）
- 降低摄像头分辨率（640x480 → 320x240）

### 3. 添加加载动画
```jsx
// 在 App.tsx 中添加
{!isModelReady && (
  <div className="loading-screen">
    <div className="spinner"></div>
    <p>正在加载 AI 模型...</p>
  </div>
)}
```

---

## 🔐 安全和隐私

### 摄像头数据处理
- ✅ 所有处理都在浏览器本地完成
- ✅ 不会上传任何视频或图像到服务器
- ✅ 符合 GDPR 和隐私保护要求

### 第三方依赖
- MediaPipe (Google) - 开源 AI 框架
- Three.js - MIT 许可证

---

## 📚 扩展学习资源

### 摄像头和媒体流
- [MDN: MediaDevices.getUserMedia()](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)
- [WebRTC 权限指南](https://web.dev/camera-access/)

### WebAssembly
- [WASM 官方文档](https://webassembly.org/)
- [SharedArrayBuffer 安全要求](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer)

### MediaPipe
- [MediaPipe 官方文档](https://developers.google.com/mediapipe)
- [Hand Landmarker 示例](https://mediapipe-studio.webapps.google.com/demo/hand_landmarker)

### Netlify 部署
- [Netlify 文档](https://docs.netlify.com/)
- [自定义头配置](https://docs.netlify.com/routing/headers/)

---

## 🎉 总结

您现在应该可以：
1. ✅ 在本地运行项目（使用 HTTP）
2. ✅ 部署到 Netlify（自动 HTTPS）
3. ✅ 在电脑和手机上测试摄像头
4. ✅ 理解摄像头 + AI 项目的核心原理

**最重要的三点：**
1. 📹 摄像头需要 HTTPS（localhost 除外）
2. 🧩 WASM 需要特殊的跨域头
3. 📦 静态资源使用绝对路径

如有问题，请检查浏览器控制台的详细日志！
